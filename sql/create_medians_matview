CREATE MATERIALIZED VIEW public.medians
AS
/*
medians materialized view
rows: sectors + general + total
*/
SELECT
	fin.sector,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY fundraising_cost_ratio) fundraising_cost_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY contribution_reliance_ratio) contribution_reliance_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY spending_ratio) spending_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY program_output_ratio) program_output_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY degree_of_lt_investment) degree_of_lt_investment,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY cur_asset_turnover) cur_asset_turnover
FROM pretty_financials fin
GROUP BY fin.sector
UNION
SELECT
	'General',
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY fundraising_cost_ratio) fundraising_cost_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY contribution_reliance_ratio) contribution_reliance_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY spending_ratio) spending_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY program_output_ratio) program_output_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY degree_of_lt_investment) degree_of_lt_investment,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY cur_asset_turnover) cur_asset_turnover
FROM pretty_financials fin
LEFT JOIN sector_flags ON fin.sector = sector_flags.sector
WHERE sector_flags.general = TRUE
UNION
SELECT
	'Total',
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY fundraising_cost_ratio) fundraising_cost_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY contribution_reliance_ratio) contribution_reliance_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY spending_ratio) spending_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY program_output_ratio) program_output_ratio,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY degree_of_lt_investment) degree_of_lt_investment,
	PERCENTILE_DISC(0.5) WITHIN GROUP (ORDER BY cur_asset_turnover) cur_asset_turnover
FROM pretty_financials fin

WITH DATA;
